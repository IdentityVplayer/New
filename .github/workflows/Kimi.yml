name: æ¯æ—¥æ–°é—»æŠ“å–

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤©8:00ï¼ˆUTC 0:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # ç§»é™¤ cache å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ requirements.txt

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: çˆ¬å–æ–°é—»å¹¶ç”ŸæˆHTML
        run: |
          python - << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime
          import os
          import sys

          # è·å–å½“å‰æ—¥æœŸ
          now = datetime.now()
          year = now.strftime('%Y')
          month = now.strftime('%m')
          date_str = now.strftime('%Y-%m-%d')

          # ç¡®ä¿ç›®å½•å­˜åœ¨
          os.makedirs(f'news/{year}/{month}', exist_ok=True)

          # çˆ¬å–æ•°æ®
          url = 'https://tophub.today/c/news'
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          }
          
          try:
              response = requests.get(url, headers=headers, timeout=30)
              response.raise_for_status()
              response.encoding = 'utf-8'
              
              soup = BeautifulSoup(response.text, 'html.parser')
              
              news_list = []
              table = soup.find('table', class_='table')
              if table:
                  rows = table.find_all('tr')[1:]
                  for row in rows:
                      cols = row.find_all('td')
                      if len(cols) >= 3:
                          rank = cols[0].text.strip()
                          title_elem = cols[1].find('a')
                          if title_elem:
                              title = title_elem.text.strip()
                              link = title_elem.get('href', '')
                              
                              if link and not link.startswith('http'):
                                  link = 'https://tophub.today' + link
                                  
                              heat = cols[2].text.strip()
                              
                              news_list.append({
                                  'rank': rank,
                                  'title': title,
                                  'heat': heat,
                                  'link': link
                              })

              # ç”ŸæˆHTML
              html_content = f'''<!DOCTYPE html>
              <html lang="zh-CN">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>ä»Šæ—¥æ–°é—» - {date_str}</title>
                  <style>
                      body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
                      .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }}
                      h1 {{ color: #2c3e50; text-align: center; margin-bottom: 10px; }}
                      .date {{ text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 1.1em; }}
                      table {{ width: 100%; border-collapse: collapse; font-size: 1em; }}
                      th, td {{ padding: 14px; text-align: left; border-bottom: 1px solid #ecf0f1; }}
                      th {{ background-color: #f8f9fa; font-weight: 600; color: #2c3e50; }}
                      tr:hover {{ background-color: #f8f9fa; }}
                      a {{ color: #3498db; text-decoration: none; }}
                      a:hover {{ color: #2980b9; text-decoration: underline; }}
                      .heat {{ color: #e74c3c; font-weight: 600; }}
                      .rank {{ color: #95a5a6; font-weight: 600; width: 80px; }}
                  </style>
              </head>
              <body>
                  <div class="container">
                      <h1>ğŸ“° ä»Šæ—¥æ–°é—»çƒ­ç‚¹</h1>
                      <p class="date">{date_str}</p>
                      <table>
                          <thead>
                              <tr>
                                  <th>æ’å</th>
                                  <th>æ ‡é¢˜</th>
                                  <th>çƒ­åº¦</th>
                              </tr>
                          </thead>
                          <tbody>'''
              
              for news in news_list:
                  html_content += f'''
                              <tr>
                                  <td class="rank">{news['rank']}</td>
                                  <td><a href="{news['link']}" target="_blank" rel="noopener noreferrer">{news['title']}</a></td>
                                  <td class="heat">{news['heat']}</td>
                              </tr>'''
              
              html_content += '''
                          </tbody>
                      </table>
                  </div>
              </body>
              </html>
              '''
              
              # ä¿å­˜HTMLæ–‡ä»¶
              file_path = f'news/{year}/{month}/{date_str}.html'
              with open(file_path, 'w', encoding='utf-8') as f:
                  f.write(html_content)
              
              print(f'âœ… æ–°é—»å·²ä¿å­˜åˆ°: {file_path}')
              print(f'ğŸ“Š å…±æŠ“å– {len(news_list)} æ¡æ–°é—»')
              
          except Exception as e:
              print(f'âŒ çˆ¬å–å¤±è´¥: {str(e)}')
              sys.exit(1)
          EOF

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          DATE_STR=$(date +%Y-%m-%d)
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶
          if [[ -n $(git status -s) ]]; then
            git add news/
            git commit -m "ğŸ“° æ·»åŠ  ${DATE_STR} æ–°é—»" || echo "âš ï¸ æ²¡æœ‰å˜æ›´"
            git push || echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆ†æ”¯æƒé™"
          else
            echo "âš ï¸ æ²¡æœ‰æ–°æ–‡ä»¶éœ€è¦æäº¤"
          fi
