name: æ¯æ—¥æ–°é—»çˆ¬å–ä¸è‡ªåŠ¨éƒ¨ç½²
on:
  # æ¯æ—¥0:00 UTC+8æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 = åŒ—äº¬æ—¶é—´ 00:00
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  news-crawler:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆæ¨é€ä»£ç åˆ°GitHubä»“åº“çš„æƒé™

    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç 
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. å®‰è£…Pythonç¯å¢ƒï¼ˆç”¨äºçˆ¬è™«å’ŒHTMLç”Ÿæˆï¼‰
      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 python-dotenv

      # 4. æ‰§è¡Œæ–°é—»çˆ¬å–å’ŒHTMLç”Ÿæˆ
      - name: çˆ¬å–æ˜¨æ—¥æ–°é—»å¹¶ç”ŸæˆHTML
        run: |
          # è®¡ç®—æ˜¨æ—¥æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYYMMDDï¼‰
          YESTERDAY=$(date -d "yesterday" +%Y%m%d)
          YEAR=$(date -d "yesterday" +%Y)
          MONTH=$(date -d "yesterday" +%m)

          # å®šä¹‰æ–‡ä»¶è·¯å¾„ï¼ˆæŒ‰å¹´/æœˆ/æ—¥ç»“æ„ï¼‰
          NEWS_DIR="news/$YEAR/$MONTH"
          NEWS_FILE="$NEWS_DIR/$YESTERDAY.html"
          INDEX_FILE="index.html"

          # åˆ›å»ºæŒ‰å¹´/æœˆçš„ç›®å½•ç»“æ„ï¼ˆ-på‚æ•°è‡ªåŠ¨åˆ›å»ºå¤šçº§ç›®å½•ï¼‰
          mkdir -p "$NEWS_DIR"

          # æ‰§è¡Œæ–°é—»çˆ¬å–ï¼ˆæ¨¡æ‹Ÿä»å¤šä¸ªæ¥æºè·å–æ–°é—»ï¼‰
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import json

          # æ¨¡æ‹Ÿä»å¤šä¸ªæ–°é—»æ¥æºè·å–æ˜¨æ—¥æ–°é—»
          def get_yesterday_news():
              news_sources = [
                  {
                      'name': 'æ–°æµªæ–°é—»',
                      'url': 'https://news.sina.com.cn/'
                  },
                  {
                      'name': 'è…¾è®¯æ–°é—»',
                      'url': 'https://news.qq.com/'
                  },
                  {
                      'name': 'ç½‘æ˜“æ–°é—»',
                      'url': 'https://news.163.com/'
                  }
              ]

              all_news = []

              for source in news_sources:
                  try:
                      # å‘é€HTTPè¯·æ±‚è·å–é¡µé¢å†…å®¹
                      response = requests.get(source['url'], timeout=10)
                      response.encoding = 'utf-8'
                      soup = BeautifulSoup(response.text, 'html.parser')

                      # æ¨¡æ‹Ÿè§£ææ–°é—»å†…å®¹ï¼ˆéœ€è¦æ ¹æ®å®é™…ç½‘ç«™ç»“æ„è°ƒæ•´ï¼‰
                      # è¿™é‡Œç®€å•æå–æ ‡é¢˜å’Œé“¾æ¥
                      news_items = soup.find_all('a', class_='news-item')[:5]  # å–å‰5æ¡æ–°é—»

                      for item in news_items:
                          news = {
                              'source': source['name'],
                              'title': item.get_text(strip=True),
                              'link': item['href']
                          }
                          all_news.append(news)

                  except Exception as e:
                      print(f"ä»{source['name']}è·å–æ–°é—»å¤±è´¥: {e}")

              return all_news

          # è·å–æ˜¨æ—¥æ–°é—»
          news_data = get_yesterday_news()

          # ç”ŸæˆHTMLå†…å®¹
          html_content = f\"\"\"<!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <title>{YESTERDAY} æ–°é—»æ±‡æ€»</title>
              <style>
                  body {{ font-family: Arial, sans-serif; margin: 20px; }}
                  .news-item {{ margin-bottom: 20px; padding: 10px; border: 1px solid #eee; }}
                  .source {{ color: #666; font-size: 0.9em; }}
                  .title {{ font-size: 1.2em; font-weight: bold; }}
              </style>
          </head>
          <body>
              <h1>{YESTERDAY} æ–°é—»æ±‡æ€»</h1>
          \"\"\"

          # æ·»åŠ æ–°é—»åˆ—è¡¨
          for i, news in enumerate(news_data, 1):
              html_content += f\"\"\"
              <div class="news-item">
                  <div class="source">æ¥æº: {news['source']}</div>
                  <div class="title"><a href="{news['link']}">{i}. {news['title']}</a></div>
              </div>
              \"\"\"

          html_content += \"</body></html>\"

          # å†™å…¥æ–°é—»HTMLæ–‡ä»¶
          with open('$NEWS_FILE', 'w', encoding='utf-8') as f:
              f.write(html_content)

          print(f"å·²ç”Ÿæˆæ–°é—»æ–‡ä»¶: {NEWS_FILE}")
          print(f"å…±è·å– {len(news_data)} æ¡æ–°é—»")
          "

      # 5. æ›´æ–°æˆ–åˆ›å»ºindex.htmlæ–‡ä»¶
      - name: æ›´æ–°æˆ–åˆ›å»ºä¸»é¡µindex.html
        run: |
          # è®¡ç®—æ˜¨æ—¥æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYYå¹´MMæœˆDDæ—¥ï¼‰
          YESTERDAY_FULL=$(date -d "yesterday" +%Yå¹´%mæœˆ%dæ—¥)
          YEAR=$(date -d "yesterday" +%Y)
          MONTH=$(date -d "yesterday" +%m)
          DAY=$(date -d "yesterday" +%d)

          # å®šä¹‰æ–‡ä»¶è·¯å¾„
          NEWS_DIR="news/$YEAR/$MONTH"
          NEWS_FILE="$NEWS_DIR/$(date -d "yesterday" +%Y%m%d).html"
          INDEX_FILE="index.html"

          # åˆ›å»ºä¸»é¡µå†…å®¹
          INDEX_CONTENT="<!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <title>æ¯æ—¥æ–°é—»æ±‡æ€»</title>
              <style>
                  body {{ font-family: Arial, sans-serif; margin: 20px; }}
                  .news-link {{ margin-bottom: 10px; }}
                  h1 {{ color: #333; }}
              </style>
          </head>
          <body>
              <h1>æ¯æ—¥æ–°é—»æ±‡æ€»</h1>
          "

          # æ·»åŠ æ–°é—»é“¾æ¥ï¼ˆå€’åºæ’åˆ—ï¼Œæœ€æ–°åœ¨é¡¶éƒ¨ï¼‰
          INDEX_CONTENT+="<ul>"

          # æŸ¥æ‰¾æ‰€æœ‰æ–°é—»æ–‡ä»¶å¹¶ç”Ÿæˆé“¾æ¥
          find news/ -type f -name "*.html" | sort -r | while read -r file; do
              # æå–æ—¥æœŸä¿¡æ¯
              date_str=$(basename "$file" .html)
              year=${date_str:0:4}
              month=${date_str:4:2}
              day=${date_str:6:2}
              friendly_date="${year}å¹´${month}æœˆ${day}æ—¥"
              
              # è®¡ç®—ç›¸å¯¹è·¯å¾„
              relative_path=$(realpath --relative-to=. "$file")
              
              # æ·»åŠ é“¾æ¥
              INDEX_CONTENT+="    <li class=\"news-link\"><a href=\"$relative_path\">$friendly_date æ–°é—»</a></li>\n"
          done

          INDEX_CONTENT+="</ul></body></html>"

          # å†™å…¥ä¸»é¡µæ–‡ä»¶
          echo "$INDEX_CONTENT" > "$INDEX_FILE"

          echo "å·²æ›´æ–°æˆ–åˆ›å»ºä¸»é¡µæ–‡ä»¶: $INDEX_FILE"

      # 6. æäº¤å¹¶æ¨é€æ›´æ–°åˆ°mainåˆ†æ”¯
      - name: æäº¤å¹¶æ¨é€æ›´æ–°
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action Bot"

          # æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶
          git add .

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if git diff --quiet --cached; then
              echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          else
              # æäº¤å˜æ›´
              git commit -m "è‡ªåŠ¨æ›´æ–°ï¼š$(date -d "yesterday" +%Yå¹´%mæœˆ%dæ—¥) æ–°é—»æ±‡æ€»"
              
              # æ¨é€å˜æ›´åˆ°mainåˆ†æ”¯
              git push origin main
              echo "å·²æˆåŠŸæ¨é€æ›´æ–°åˆ°mainåˆ†æ”¯"
          fi          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
              'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
              'Referer': 'https://tophub.today/',
          }
          
          try:
              print(f'ğŸŒ æ­£åœ¨è¯·æ±‚: {url}')
              print(f'ğŸ“‹ è¯·æ±‚å¤´: {json.dumps(headers, indent=2)}')
              response = requests.get(url, headers=headers, timeout=30)
              response.raise_for_status()
              
              # æ£€æŸ¥å“åº”çŠ¶æ€
              print(f'âœ… HTTPçŠ¶æ€ç : {response.status_code}')
              print(f'ğŸ“„ å†…å®¹é•¿åº¦: {len(response.text)} å­—ç¬¦')
              print(f'ğŸ”¤ ç¼–ç : {response.encoding}')
              
              html_content = response.text
              
              # ä¿å­˜åŸå§‹HTML
              debug_file = f'news/{year}/{month}/{date_str}_debug.html'
              with open(debug_file, 'w', encoding='utf-8') as f:
                  f.write(html_content)
              print(f'ğŸ’¾ è°ƒè¯•æ–‡ä»¶å·²ä¿å­˜: {debug_file}')
              
          except Exception as e:
              print(f'âŒ è¯·æ±‚å¤±è´¥: {str(e)}')
              print(f'é”™è¯¯ç±»å‹: {type(e).__name__}')
              sys.exit(1)

          # ===== è§£æé¡µé¢ =====
          try:
              soup = BeautifulSoup(html_content, 'html.parser')
              print(f'ğŸ§ª å¼€å§‹è§£æHTML...')
              
              # æ–¹æ³•1: æŸ¥æ‰¾æ‰€æœ‰è¡¨æ ¼
              tables = soup.find_all('table')
              print(f'ğŸ“Š æ‰¾åˆ° {len(tables)} ä¸ªè¡¨æ ¼')
              
              if not tables:
                  print('âŒ æœªæ‰¾åˆ°ä»»ä½•è¡¨æ ¼')
                  # æ‰“å°é¡µé¢é‡è¦å…ƒç´ 
                  print('é¡µé¢é‡è¦å…ƒç´ é¢„è§ˆ:')
                  for tag in ['div', 'section', 'main']:
                      elements = soup.find_all(tag)
                      if elements:
                          print(f'- æ‰¾åˆ° {len(elements)} ä¸ª <{tag}> æ ‡ç­¾')
                  sys.exit(1)
              
              # éå†æ‰€æœ‰è¡¨æ ¼æŸ¥æ‰¾æ–°é—»
              news_list = []
              for table_idx, table in enumerate(tables):
                  rows = table.find_all('tr')
                  print(f'ğŸ“‹ è¡¨æ ¼ {table_idx}: æ‰¾åˆ° {len(rows)} è¡Œ')
                  
                  for row_idx, row in enumerate(rows):
                      cols = row.find_all('td')
                      if len(cols) >= 3:
                          try:
                              # æå–ä¿¡æ¯
                              rank = cols[0].text.strip()
                              title_elem = cols[1].find('a')
                              
                              if title_elem:
                                  title = title_elem.get_text(strip=True)
                                  link = title_elem.get('href', '')
                                  
                                  # å¤„ç†ç›¸å¯¹é“¾æ¥
                                  if link and link.startswith('/'):
                                      link = 'https://tophub.today' + link
                                  elif link and not link.startswith('http'):
                                      link = 'https://tophub.today/' + link
                                  
                                  heat = cols[2].text.strip()
                                  
                                  # éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
                                  if title and len(title) > 1 and heat:
                                      news_list.append({
                                          'rank': rank or str(len(news_list)+1),
                                          'title': title,
                                          'heat': heat,
                                          'link': link,
                                          'table': table_idx,
                                          'row': row_idx
                                      })
                                      print(f'âœ… æ‰¾åˆ°æ–°é—»: [{rank}] {title[:30]}... | {heat}')
                                  
                          except Exception as e:
                              print(f'âš ï¸  è§£æè¡Œå¤±è´¥ (è¡¨æ ¼{table_idx}, è¡Œ{row_idx}): {e}')
                              continue
              
              if not news_list:
                  print('âŒ æœªèƒ½æå–ä»»ä½•æ–°é—»æ•°æ®')
                  print('é¡µé¢ç»“æ„ç‰‡æ®µ:')
                  # æ‰“å°å‰500ä¸ªå­—ç¬¦æ¥è¯Šæ–­
                  print(html_content[:500])
                  sys.exit(1)
              
              print(f'ğŸ‰ æˆåŠŸæå– {len(news_list)} æ¡æ–°é—»')
              
          except Exception as e:
              print(f'âŒ è§£æå¤±è´¥: {str(e)}')
              import traceback
              traceback.print_exc()
              sys.exit(1)

          # ===== ç”ŸæˆHTML =====
          try:
              html_output = f'''<!DOCTYPE html>
              <html lang="zh-CN">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>ä»Šæ—¥æ–°é—» - {date_str}</title>
                  <style>
                      body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
                      .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }}
                      h1 {{ color: #2c3e50; text-align: center; margin-bottom: 10px; }}
                      .date {{ text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 1.1em; }}
                      table {{ width: 100%; border-collapse: collapse; font-size: 1em; }}
                      th, td {{ padding: 14px; text-align: left; border-bottom: 1px solid #ecf0f1; }}
                      th {{ background-color: #f8f9fa; font-weight: 600; color: #2c3e50; }}
                      tr:hover {{ background-color: #f8f9fa; }}
                      a {{ color: #3498db; text-decoration: none; }}
                      a:hover {{ color: #2980b9; text-decoration: underline; }}
                      .heat {{ color: #e74c3c; font-weight: 600; }}
                      .rank {{ color: #95a5a6; font-weight: 600; width: 80px; }}
                      .source {{ font-size: 0.9em; color: #7f8c8d; margin-top: 30px; text-align: center; }}
                  </style>
              </head>
              <body>
                  <div class="container">
                      <h1>ğŸ“° ä»Šæ—¥æ–°é—»çƒ­ç‚¹</h1>
                      <p class="date">{date_str}</p>
                      <table>
                          <thead>
                              <tr>
                                  <th>æ’å</th>
                                  <th>æ ‡é¢˜</th>
                                  <th>çƒ­åº¦</th>
                              </tr>
                          </thead>
                          <tbody>'''
              
              for news in news_list:
                  html_output += f'''
                              <tr>
                                  <td class="rank">{news['rank']}</td>
                                  <td><a href="{news['link']}" target="_blank" rel="noopener noreferrer">{news['title']}</a></td>
                                  <td class="heat">{news['heat']}</td>
                              </tr>'''
              
              html_output += f'''
                          </tbody>
                      </table>
                      <p class="source">æ•°æ®æ¥æºï¼štophub.today/c/news | æ›´æ–°æ—¶é—´ï¼š{now.strftime('%Y-%m-%d %H:%M:%S UTC')}</p>
                      <p class="source">å…±æŠ“å– {len(news_list)} æ¡æ–°é—»</p>
                  </div>
              </body>
              </html>
              '''
              
              output_file = f'news/{year}/{month}/{date_str}.html'
              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write(html_output)
              
              print(f'âœ… HTMLç”ŸæˆæˆåŠŸ: {output_file}')
              
              # æ‰“å°æ–‡ä»¶å¤§å°
              file_size = os.path.getsize(output_file)
              print(f'ğŸ“¦ æ–‡ä»¶å¤§å°: {file_size} å­—èŠ‚')
              
          except Exception as e:
              print(f'âŒ ç”ŸæˆHTMLå¤±è´¥: {str(e)}')
              sys.exit(1)

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥gitçŠ¶æ€
          echo "GitçŠ¶æ€:"
          git status
          
          if [[ -n $(git status -s) ]]; then
            git add news/
            git commit -m "ğŸ“° æ·»åŠ  $(date +%Y-%m-%d) æ–°é—»"
            echo "ğŸ“ æäº¤æˆåŠŸ"
            git push
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "âš ï¸ æ²¡æœ‰æ–°æ–‡ä»¶éœ€è¦æäº¤"
          fi
