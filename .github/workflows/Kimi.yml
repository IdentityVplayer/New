name: æ¯æ—¥æ–°é—»æŠ“å–

on:
  schedule:
    - cron: '0 0 * * *'  # UTC 0:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 lxml

      - name: çˆ¬å–æ–°é—»å¹¶ç”ŸæˆHTML
        run: |
          python - << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime
          import os, sys, re

          now = datetime.now()
          year, month, date_str = now.strftime('%Y'), now.strftime('%m'), now.strftime('%Y-%m-%d')
          os.makedirs(f'news/{year}/{month}', exist_ok=True)

          # ===== çˆ¬å–é¡µé¢ =====
          url = 'https://tophub.today/c/news'
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept-Language': 'zh-CN,zh;q=0.9'
          }
          
          try:
              print(f'ğŸŒ æ­£åœ¨è¯·æ±‚: {url}')
              response = requests.get(url, headers=headers, timeout=30)
              response.raise_for_status()
              html_content = response.text
              
              # ä¿å­˜åŸå§‹HTMLç”¨äºè°ƒè¯•
              debug_html = f'news/{year}/{month}/{date_str}_raw.html'
              with open(debug_html, 'w', encoding='utf-8') as f:
                  f.write(html_content)
              print(f'ğŸ’¾ åŸå§‹HTMLå·²ä¿å­˜åˆ°: {debug_html}')
              
          except Exception as e:
              print(f'âŒ è¯·æ±‚å¤±è´¥: {str(e)}')
              sys.exit(1)

          # ===== è§£æé¡µé¢ =====
          try:
              soup = BeautifulSoup(html_content, 'html.parser')
              news_list = []
              
              # ç­–ç•¥1: æŸ¥æ‰¾æ‰€æœ‰è¡¨æ ¼è¡Œ
              rows = soup.find_all('tr')
              print(f'ğŸ“Š æ‰¾åˆ° {len(rows)} ä¸ªè¡¨æ ¼è¡Œ')
              
              if not rows:
                  print('âŒ æœªæ‰¾åˆ°ä»»ä½•è¡¨æ ¼è¡Œ')
                  # æ‰“å°é¡µé¢ç»“æ„å¸®åŠ©è¯Šæ–­
                  print('é¡µé¢ç»“æ„é¢„è§ˆ:')
                  print(soup.prettify()[:2000])
                  sys.exit(1)
              
              # è§£ææ¯ä¸€è¡Œ
              for idx, row in enumerate(rows):
                  cols = row.find_all('td')
                  if len(cols) >= 3:
                      try:
                          rank = cols[0].text.strip()
                          title_elem = cols[1].find('a')
                          if title_elem:
                              title = title_elem.get_text(strip=True)
                              link = title_elem.get('href', '')
                              if link and not link.startswith('http'):
                                  link = 'https://tophub.today' + link
                              
                              heat = cols[2].text.strip()
                              
                              if title and len(title) > 2:  # ç¡®ä¿æ ‡é¢˜æœ‰æ•ˆ
                                  news_list.append({
                                      'rank': rank or str(len(news_list)+1),
                                      'title': title,
                                      'heat': heat,
                                      'link': link
                                  })
                      except:
                          continue
              
              if not news_list:
                  print('âŒ æœªæå–åˆ°æœ‰æ•ˆæ–°é—»æ•°æ®')
                  # æ‰“å°å‰å‡ ä¸ªè¡Œçš„ç»“æ„
                  print('å‰3è¡Œç»“æ„:')
                  for i, row in enumerate(rows[:3]):
                      print(f'è¡Œ {i}: {row}')
                  sys.exit(1)
              
              print(f'âœ… æˆåŠŸæå– {len(news_list)} æ¡æ–°é—»')
              
          except Exception as e:
              print(f'âŒ è§£æå¤±è´¥: {str(e)}')
              import traceback
              traceback.print_exc()
              sys.exit(1)

          # ===== ç”ŸæˆHTML =====
          try:
              html_output = f'''<!DOCTYPE html>
              <html lang="zh-CN">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>ä»Šæ—¥æ–°é—» - {date_str}</title>
                  <style>
                      body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
                      .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }}
                      h1 {{ color: #2c3e50; text-align: center; margin-bottom: 10px; }}
                      .date {{ text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 1.1em; }}
                      table {{ width: 100%; border-collapse: collapse; font-size: 1em; }}
                      th, td {{ padding: 14px; text-align: left; border-bottom: 1px solid #ecf0f1; }}
                      th {{ background-color: #f8f9fa; font-weight: 600; color: #2c3e50; }}
                      tr:hover {{ background-color: #f8f9fa; }}
                      a {{ color: #3498db; text-decoration: none; }}
                      a:hover {{ color: #2980b9; text-decoration: underline; }}
                      .heat {{ color: #e74c3c; font-weight: 600; }}
                      .rank {{ color: #95a5a6; font-weight: 600; width: 80px; }}
                      .source {{ font-size: 0.9em; color: #7f8c8d; margin-top: 30px; text-align: center; }}
                  </style>
              </head>
              <body>
                  <div class="container">
                      <h1>ğŸ“° ä»Šæ—¥æ–°é—»çƒ­ç‚¹</h1>
                      <p class="date">{date_str}</p>
                      <table>
                          <thead>
                              <tr>
                                  <th>æ’å</th>
                                  <th>æ ‡é¢˜</th>
                                  <th>çƒ­åº¦</th>
                              </tr>
                          </thead>
                          <tbody>'''
              
              for news in news_list:
                  html_output += f'''
                              <tr>
                                  <td class="rank">{news['rank']}</td>
                                  <td><a href="{news['link']}" target="_blank" rel="noopener noreferrer">{news['title']}</a></td>
                                  <td class="heat">{news['heat']}</td>
                              </tr>'''
              
              html_output += f'''
                          </tbody>
                      </table>
                      <p class="source">æ•°æ®æ¥æºï¼štophub.today/c/news | æ›´æ–°æ—¶é—´ï¼š{now.strftime('%Y-%m-%d %H:%M:%S')}</p>
                  </div>
              </body>
              </html>
              '''
              
              # ä¿å­˜HTML
              output_file = f'news/{year}/{month}/{date_str}.html'
              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write(html_output)
              
              print(f'âœ… æ–°é—»HTMLå·²ç”Ÿæˆ: {output_file}')
              
          except Exception as e:
              print(f'âŒ ç”ŸæˆHTMLå¤±è´¥: {str(e)}')
              sys.exit(1)

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ -n $(git status -s) ]]; then
            git add news/
            git commit -m "ğŸ“° æ·»åŠ  $(date +%Y-%m-%d) æ–°é—»"
            git push
          else
            echo "âš ï¸ æ²¡æœ‰æ–°æ–‡ä»¶éœ€è¦æäº¤"
          fi
