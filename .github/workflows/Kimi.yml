name: æ¯æ—¥æ–°é—»æŠ“å–

on:
  schedule:
    - cron: '0 0 * * *'  # UTC 0:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 lxml

      - name: çˆ¬å–æ–°é—»å¹¶ç”ŸæˆHTML
        run: |
          python - << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime, timezone
          import os, sys, re, json

          # ===== é…ç½® =====
          now = datetime.now(timezone.utc)
          year, month, date_str = now.strftime('%Y'), now.strftime('%m'), now.strftime('%Y-%m-%d')
          os.makedirs(f'news/{year}/{month}', exist_ok=True)

          # ===== è¯·æ±‚é¡µé¢ =====
          url = 'https://tophub.today/c/news'
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
              'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
              'Referer': 'https://tophub.today/',
          }
          
          try:
              print(f'ğŸŒ æ­£åœ¨è¯·æ±‚: {url}')
              print(f'ğŸ“‹ è¯·æ±‚å¤´: {json.dumps(headers, indent=2)}')
              response = requests.get(url, headers=headers, timeout=30)
              response.raise_for_status()
              
              # æ£€æŸ¥å“åº”çŠ¶æ€
              print(f'âœ… HTTPçŠ¶æ€ç : {response.status_code}')
              print(f'ğŸ“„ å†…å®¹é•¿åº¦: {len(response.text)} å­—ç¬¦')
              print(f'ğŸ”¤ ç¼–ç : {response.encoding}')
              
              html_content = response.text
              
              # ä¿å­˜åŸå§‹HTML
              debug_file = f'news/{year}/{month}/{date_str}_debug.html'
              with open(debug_file, 'w', encoding='utf-8') as f:
                  f.write(html_content)
              print(f'ğŸ’¾ è°ƒè¯•æ–‡ä»¶å·²ä¿å­˜: {debug_file}')
              
          except Exception as e:
              print(f'âŒ è¯·æ±‚å¤±è´¥: {str(e)}')
              print(f'é”™è¯¯ç±»å‹: {type(e).__name__}')
              sys.exit(1)

          # ===== è§£æé¡µé¢ =====
          try:
              soup = BeautifulSoup(html_content, 'html.parser')
              print(f'ğŸ§ª å¼€å§‹è§£æHTML...')
              
              # æ–¹æ³•1: æŸ¥æ‰¾æ‰€æœ‰è¡¨æ ¼
              tables = soup.find_all('table')
              print(f'ğŸ“Š æ‰¾åˆ° {len(tables)} ä¸ªè¡¨æ ¼')
              
              if not tables:
                  print('âŒ æœªæ‰¾åˆ°ä»»ä½•è¡¨æ ¼')
                  # æ‰“å°é¡µé¢é‡è¦å…ƒç´ 
                  print('é¡µé¢é‡è¦å…ƒç´ é¢„è§ˆ:')
                  for tag in ['div', 'section', 'main']:
                      elements = soup.find_all(tag)
                      if elements:
                          print(f'- æ‰¾åˆ° {len(elements)} ä¸ª <{tag}> æ ‡ç­¾')
                  sys.exit(1)
              
              # éå†æ‰€æœ‰è¡¨æ ¼æŸ¥æ‰¾æ–°é—»
              news_list = []
              for table_idx, table in enumerate(tables):
                  rows = table.find_all('tr')
                  print(f'ğŸ“‹ è¡¨æ ¼ {table_idx}: æ‰¾åˆ° {len(rows)} è¡Œ')
                  
                  for row_idx, row in enumerate(rows):
                      cols = row.find_all('td')
                      if len(cols) >= 3:
                          try:
                              # æå–ä¿¡æ¯
                              rank = cols[0].text.strip()
                              title_elem = cols[1].find('a')
                              
                              if title_elem:
                                  title = title_elem.get_text(strip=True)
                                  link = title_elem.get('href', '')
                                  
                                  # å¤„ç†ç›¸å¯¹é“¾æ¥
                                  if link and link.startswith('/'):
                                      link = 'https://tophub.today' + link
                                  elif link and not link.startswith('http'):
                                      link = 'https://tophub.today/' + link
                                  
                                  heat = cols[2].text.strip()
                                  
                                  # éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
                                  if title and len(title) > 1 and heat:
                                      news_list.append({
                                          'rank': rank or str(len(news_list)+1),
                                          'title': title,
                                          'heat': heat,
                                          'link': link,
                                          'table': table_idx,
                                          'row': row_idx
                                      })
                                      print(f'âœ… æ‰¾åˆ°æ–°é—»: [{rank}] {title[:30]}... | {heat}')
                                  
                          except Exception as e:
                              print(f'âš ï¸  è§£æè¡Œå¤±è´¥ (è¡¨æ ¼{table_idx}, è¡Œ{row_idx}): {e}')
                              continue
              
              if not news_list:
                  print('âŒ æœªèƒ½æå–ä»»ä½•æ–°é—»æ•°æ®')
                  print('é¡µé¢ç»“æ„ç‰‡æ®µ:')
                  # æ‰“å°å‰500ä¸ªå­—ç¬¦æ¥è¯Šæ–­
                  print(html_content[:500])
                  sys.exit(1)
              
              print(f'ğŸ‰ æˆåŠŸæå– {len(news_list)} æ¡æ–°é—»')
              
          except Exception as e:
              print(f'âŒ è§£æå¤±è´¥: {str(e)}')
              import traceback
              traceback.print_exc()
              sys.exit(1)

          # ===== ç”ŸæˆHTML =====
          try:
              html_output = f'''<!DOCTYPE html>
              <html lang="zh-CN">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>ä»Šæ—¥æ–°é—» - {date_str}</title>
                  <style>
                      body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
                      .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }}
                      h1 {{ color: #2c3e50; text-align: center; margin-bottom: 10px; }}
                      .date {{ text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 1.1em; }}
                      table {{ width: 100%; border-collapse: collapse; font-size: 1em; }}
                      th, td {{ padding: 14px; text-align: left; border-bottom: 1px solid #ecf0f1; }}
                      th {{ background-color: #f8f9fa; font-weight: 600; color: #2c3e50; }}
                      tr:hover {{ background-color: #f8f9fa; }}
                      a {{ color: #3498db; text-decoration: none; }}
                      a:hover {{ color: #2980b9; text-decoration: underline; }}
                      .heat {{ color: #e74c3c; font-weight: 600; }}
                      .rank {{ color: #95a5a6; font-weight: 600; width: 80px; }}
                      .source {{ font-size: 0.9em; color: #7f8c8d; margin-top: 30px; text-align: center; }}
                  </style>
              </head>
              <body>
                  <div class="container">
                      <h1>ğŸ“° ä»Šæ—¥æ–°é—»çƒ­ç‚¹</h1>
                      <p class="date">{date_str}</p>
                      <table>
                          <thead>
                              <tr>
                                  <th>æ’å</th>
                                  <th>æ ‡é¢˜</th>
                                  <th>çƒ­åº¦</th>
                              </tr>
                          </thead>
                          <tbody>'''
              
              for news in news_list:
                  html_output += f'''
                              <tr>
                                  <td class="rank">{news['rank']}</td>
                                  <td><a href="{news['link']}" target="_blank" rel="noopener noreferrer">{news['title']}</a></td>
                                  <td class="heat">{news['heat']}</td>
                              </tr>'''
              
              html_output += f'''
                          </tbody>
                      </table>
                      <p class="source">æ•°æ®æ¥æºï¼štophub.today/c/news | æ›´æ–°æ—¶é—´ï¼š{now.strftime('%Y-%m-%d %H:%M:%S UTC')}</p>
                      <p class="source">å…±æŠ“å– {len(news_list)} æ¡æ–°é—»</p>
                  </div>
              </body>
              </html>
              '''
              
              output_file = f'news/{year}/{month}/{date_str}.html'
              with open(output_file, 'w', encoding='utf-8') as f:
                  f.write(html_output)
              
              print(f'âœ… HTMLç”ŸæˆæˆåŠŸ: {output_file}')
              
              # æ‰“å°æ–‡ä»¶å¤§å°
              file_size = os.path.getsize(output_file)
              print(f'ğŸ“¦ æ–‡ä»¶å¤§å°: {file_size} å­—èŠ‚')
              
          except Exception as e:
              print(f'âŒ ç”ŸæˆHTMLå¤±è´¥: {str(e)}')
              sys.exit(1)

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥gitçŠ¶æ€
          echo "GitçŠ¶æ€:"
          git status
          
          if [[ -n $(git status -s) ]]; then
            git add news/
            git commit -m "ğŸ“° æ·»åŠ  $(date +%Y-%m-%d) æ–°é—»"
            echo "ğŸ“ æäº¤æˆåŠŸ"
            git push
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "âš ï¸ æ²¡æœ‰æ–°æ–‡ä»¶éœ€è¦æäº¤"
          fi
