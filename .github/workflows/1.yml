# .github/workflows/daily-news.yml

name: Daily TopHub Scraper

on:
  # 每日 0:00 UTC 执行 (对应北京时间早上8点)
  # 如果需要北京时间0点执行，请改为 '16 * * * *'
  schedule:
    - cron: '0 0 * * *'
  # 允许在 GitHub Actions 页面手动触发此工作流
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 授予工作流向仓库写入内容的权限

    steps:
      # 步骤 1: 检出您的代码仓库
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤 2: 安装 pup (一个用于解析HTML的命令行工具)
      - name: Install pup
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          # 从GitHub下载pup的二进制文件并安装
          curl -L https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip -o pup.zip
          unzip pup.zip
          sudo mv pup /usr/local/bin/

      # 步骤 3: 爬取网页、生成HTML并更新索引
      - name: Scrape website, generate HTML, and update index
        id: generate_news
        run: |
          # --- A. 定义变量 ---
          TODAY=$(date +%Y-%m-%d)
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          NEWS_DIR="${YEAR}/${MONTH}"
          NEWS_FILE="${NEWS_DIR}/${TODAY}.html"
          INDEX_FILE="index.html"

          # 将日期输出，以便后续步骤可以使用
          echo "commit_date=${TODAY}" >> $GITHUB_OUTPUT

          echo "开始为日期 ${TODAY} 爬取 tophub.today 热榜..."
          echo "文件将保存在: ${NEWS_FILE}"

          # --- B. 爬取网页内容 ---
          # 目标URL，这里以“知乎热榜”为例。您可以换成其他榜单的URL。
          TARGET_URL="https://tophub.today/n/mproPpoq6O"
          
          # 使用 curl 下载网页 HTML
          curl -s -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" "$TARGET_URL" -o tophub.html
          
          if [ ! -s tophub.html ]; then
            echo "错误：无法下载网页或网页内容为空。"
            exit 1
          fi

          # --- C. 生成新闻 HTML 文件 ---
          mkdir -p $NEWS_DIR

          # 创建 HTML 文件头部
          echo "<!DOCTYPE html>
          <html lang='zh-CN'>
          <head>
            <meta charset='UTF-8'>
            <meta name='viewport' content='width=device-width, initial-scale=1.0'>
            <title>知乎热榜 - ${TODAY}</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; margin: 2em; line-height: 1.6; }
              h1 { color: #1f2328; }
              ol { padding-left: 20px; }
              li { margin-bottom: 10px; }
              a { color: #0969da; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .metrics { font-size: 0.9em; color: #57606a; margin-left: 10px; }
            </style>
          </head>
          <body>
            <h1>知乎热榜 (${TODAY})</h1>
            <ol>" > $NEWS_FILE

          # 使用 pup 解析HTML并提取热榜条目
          # 选择器 'div.Zd-p-Sc' 选中每个热榜条目的容器
          # 'a' 提取链接
          # 'span.Zd-h-aV' 提取热度值
          # pup 'div.Zd-p-Sc' --text-filter '\S' 表示选择所有包含非空白字符的条目
          pup 'div.Zd-p-Sc json{}' < tophub.html | jq -r '.[] | .children[] | select(.tag=="a") | .href, .text, (.children[] | select(.tag=="span") | .text)' | while read -r link; read -r title; read -r metrics; do
            # 拼接成完整的URL
            full_link="https://tophub.today${link}"
            echo "  <li><a href='${full_link}' target='_blank' rel='noopener noreferrer'>${title}</a><span class='metrics'>${metrics}</span></li>" >> $NEWS_FILE
          done

          # 创建 HTML 文件尾部
          echo "</ol></body></html>" >> $NEWS_FILE
          echo "热榜文件 ${NEWS_FILE} 已生成。"

          # --- D. 更新 index.html ---
          if [ ! -f "$INDEX_FILE" ]; then
            echo "<!DOCTYPE html><html lang='zh-CN'><head><title>热榜归档</title><style>body { font-family: sans-serif; margin: 2em; }</style></head><body><h1>热榜归档</h1><ul></ul></body></html>" > $INDEX_FILE
            echo "创建了新的 ${INDEX_FILE}。"
          fi

          sed -i "/<ul>/a \ \ \ \ \ \ \ \ \ \ \ \ <li><a href='${NEWS_FILE}'>${TODAY} 的知乎热榜</a></li>" $INDEX_FILE
          echo "${INDEX_FILE} 已更新。"

      # 步骤 4: 提交并推送到 main 分支
      - name: Commit and push if changes exist
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(tophub): 自动更新 ${{ steps.generate_news.outputs.commit_date }} 的知乎热榜"
          file_pattern: "**/*.html"
