name: Daily Hot Topics Generator (Single File)

on:
  schedule:
    # 每天 UTC 时间 16:00 运行，相当于北京时间（UTC+8）的每天凌晨 00:00
    - cron: '0 16 * * *'
  workflow_dispatch:

jobs:
  generate_news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 markdown

      - name: Run hot topics script and generate HTML
        id: generate
        run: |
          # Python 脚本逻辑直接嵌入到 YAML 中
          python - <<EOF
import requests
from bs4 import BeautifulSoup
import markdown
import datetime
import os

def get_hot_topics(limit=10):
    """从通用新闻源获取热点新闻标题和链接。"""
    print("正在获取网络热点...")
    topics = []
    # 使用 Google News 的 RSS 作为通用热点源
    rss_url = "https://news.google.com/rss?hl=zh-CN&gl=CN&ceid=CN:zh-Hans"
    
    try:
        response = requests.get(rss_url, timeout=10)
        response.raise_for_status()
        
        soup = BeautifulSoup(response.content, 'xml')
        items = soup.find_all('item')
        
        for i, item in enumerate(items):
            if i >= limit:
                break
            title = item.find('title').text
            link = item.find('link').text
            topics.append({
                'title': title,
                'link': link
            })
        print(f"成功获取 {len(topics)} 个热点。")
    except requests.exceptions.RequestException as e:
        print(f"获取热点失败: {e}")
        topics.append({
            'title': '网络热点获取失败，请检查网络或爬虫源。',
            'link': '#'
        })
        
    return topics

def generate_markdown(topics):
    """将热点列表转换为Markdown格式的字符串。"""
    today = datetime.date.today().strftime("%Y年%m月%d日")
    
    md_content = f"# 每日网络热点 - {today}\n\n"
    md_content += "## 今日热点概览\n\n"
    
    if len(topics) == 1 and topics[0]['link'] == '#':
        md_content += f"**{topics[0]['title']}**\n\n"
    else:
        for i, topic in enumerate(topics):
            md_content += f"{i+1}. [{topic['title']}]({topic['link']})\n"
            
    md_content += "\n---\n\n"
    md_content += f"**生成时间**: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
    md_content += "*本页面由GitHub Actions自动生成和部署。*\n"
    
    return md_content

def convert_md_to_html(md_content):
    """将Markdown字符串转换为完整的HTML页面。"""
    html_body = markdown.markdown(md_content)
    
    # 简单的HTML模板
    html_template = f"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日网络热点</title>
    <style>
        body {{ font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }}
        h1 {{ border-bottom: 2px solid #eee; padding-bottom: 10px; }}
        a {{ color: #0366d6; text-decoration: none; }}
        a:hover {{ text-decoration: underline; }}
        .footer {{ margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.9em; color: #6a737d; }}
    </style>
</head>
<body>
{{html_body}}
</body>
</html>"""
    
    return html_template.replace("{{html_body}}", html_body)

if __name__ == "__main__":
    hot_topics = get_hot_topics()
    md_output = generate_markdown(hot_topics)
    html_output = convert_md_to_html(md_output)
    
    output_file = "index.html"
    with open(output_file, "w", encoding="utf-8") as f:
        f.write(html_output)
    print(f"成功将 HTML 内容保存到 {output_file}")

EOF

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto: Update daily hot topics"
          # 仅提交生成的 HTML 文件
          file_pattern: 'index.html'
          # GitHub Actions 默认的 GITHUB_TOKEN 即可用于提交
          token: ${{ secrets.GITHUB_TOKEN }}
